;+
; NAME:                 DSIM
;
; PURPOSE:              A simple demo simulation. It implements two layer which are
;                       connected by a retinotopic Gaussian weight profile.
;
; CATEGORY:             MIND SIM DEMO
;
; CALLING SEQUENCE:     DSIM
;
; MODIFICATION HISTORY:
;
;     $Log$
;     Revision 1.2  2000/01/14 12:54:29  saam
;           uses the changed DWW system
;
;     Revision 1.1  2000/01/13 10:36:53  saam
;           hope it works
;
;
;-

PRO DSIM, _EXTRA=e ;,CLEAN
  
   COMMON SH_Q, Qwins, Q_1
   COMMON COMMON_Random, seed
   COMMON ATTENTION, AP, P, _TIME

;   RESOLVE_All
;   seed = 1234567

   Freeeachhandle
   UClose,/ALL

   DWWINIT = {DWWINIT         ,$
              TYPE : 'NONE'   ,$ ; ["CONST"(A), "GAUSSIAN"(A,S), "LOAD", "NONE"]
              W    :  0.0d    ,$ ; weight for complete connectionism (WEIGHT)
              A    :  0.0d    ,$ ; weight amplitude (CONST), center weight strength (GAUSSIAN)
              S    :  0.0d    ,$ ; standard deviation (GAUSSIAN)
              R    :  0       ,$ ; radius of circle where connections were created
              N    :  0.0d    ,$ ; amplitude for unifomrly distributed noise (additive)
              NORM :  0        } ; norm A to the area below the weight matrix (GAUSSIAN)


   DWDINIT = {DWDINIT         ,$
              TYPE : 'NONE'   ,$ ; ["LINEAR"(R,D,M), "NONE", "WEIGHT", "DELAY"] 
              M    :  0       ,$ ; minimal delay (LINEAR)
              D    :  0       ,$ ; maximal delay (LINEAR)
              C    :  0       ,$ ; delay (CONST/DELAY)
              R    :  0       }  ; radius of circle where connections were created (CONST/LINEAR)
              
   DWW = { DWW              ,$
           NAME   : ''      ,$
           SYNAPSE: ''      ,$
           SOURCE : 0       ,$ 
           TARGET : 0       ,$
           bound  : ''      ,$  ;["TOROID", "OPEN"]
           self   : ''      ,$  ;["SELF", "NONSELF"]
           WINIT  : DWWINIT ,$
           DINIT  : DWDINIT ,$
           T2S    : 0       ,$  ; Source2Target(0), Target2Source(1)
           FILE   : ''      }
                   
   

   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;-------> GLOBAL PARAMETERS
   SIMULATION = {VER    : '.'        ,$
                 TIME   :   1000l    ,$
                 SAMPLE :      0.001 }


   ;-------> LAYERS
   LW = LonArr(2)
   LW(0) = Handle_Create(!MH, VALUE={INFO   : 'LAYER'           ,$
                                     w      :     21            ,$
                                     h      :     21            ,$
                                     name   : 'Simple Cells'    ,$
                                     file   : 's'               ,$
                                     NPW    : {  INFO : 'NEURONPARA6' ,$
                                                 tf1  :   0.2789d      ,$
                                                 tf2  :   9.0d         ,$
                                                 tl1  :   0.3866       ,$
                                                 tl2  :   4.0d         ,$
                                                 ti   :  10.0d         ,$
                                                 vs   :   2.0d         ,$
                                                 ts   :  10.0d         ,$
                                                 vr   :   0.0d         ,$
                                                 tr   :   5.0d         ,$
                                                 t0   :   0.3d         ,$
                                                 fade : 200            ,$
                                                 n    :   0.0d         ,$
                                                 ns   :   0.0d         ,$
                                                 sn   :   0.0d         },$
                                     LEX    : { INFO       : 'LAYEREXTRA',$
                                                REC_O      : [0l, SIMULATION.TIME],$
                                                REC_M      : [0l,0l]              ,$
                                                REC_MUA    : 1                    ,$
                                                ANALYZE    : 0                    ,$
                                                SPIKERASTER: 1                    }})

   LW(1) = Handle_Create(!MH, VALUE={INFO   : 'LAYER'           ,$
                                     w      :     21            ,$
                                     h      :     21            ,$
                                     name   : 'Complex Cells'   ,$
                                     file   : 'c'               ,$
                                     NPW    : {  INFO : 'NEURONPARA6' ,$
                                                 tf1  :   0.2789d      ,$
                                                 tf2  :   9.0d         ,$
                                                 tl1  :   0.3866       ,$
                                                 tl2  :   4.0d         ,$
                                                 ti   :   6.0d         ,$
                                                 vs   :   2.0d         ,$
                                                 ts   :  10.0d         ,$
                                                 vr   :   0.0d         ,$
                                                 tr   :   0.0d         ,$
                                                 t0   :   0.3d         ,$
                                                 fade : 200            ,$
                                                 n    :   0.0d         ,$
                                                 ns   :   0.0d         ,$
                                                 sn   :   0.0d         },$
                                     LEX    : { INFO       : 'LAYEREXTRA',$
                                                REC_O      : [0l, SIMULATION.TIME],$
                                                REC_M      : [0l,0l]              ,$
                                                REC_MUA    : 1                    ,$
                                                ANALYZE    : 0                    ,$
                                                SPIKERASTER: 1                    }})



   ;-------> WATCH NEURONS
   NWatch = LonArr(2)
   NWatch(0) = Handle_Create(!MH, VALUE={L :   0,$
                                         w :  11,$
                                         h :  11})
   NWatch(1) = Handle_Create(!MH, VALUE={L :   1,$
                                         w :  11,$
                                         h :  11})


   
   ;-------> CONNECTIONS
   DWW = LonArr(1)
   DWW(0) = Handle_Create(!MH, VALUE={INFO    : 'DWW'    ,$
                                      NAME    : 'S->C'   ,$
                                      SYNAPSE : 'FEEDING',$
                                      SOURCE  : 0        ,$
                                      TARGET  : 1        ,$
                                      BOUND   : 'TOROID' ,$
                                      SELF    : 'SELF'   ,$
                                      WINIT   : {INFO : 'DWWINIT' ,$
                                                 TYPE : 'GAUSSIAN',$
                                                 A    :  0.05     ,$
                                                 S    : 10.       ,$
                                                 R    : 11        ,$
                                                 N    :  0.025    ,$
                                                 NORM :  0        },$
                                      DINIT   : {INFO : 'DWDINIT' ,$
                                                 TYPE : 'LINEAR'  ,$
                                                 M    :  1        ,$
                                                 D    : 12        ,$
                                                 R    : 11        },$
                                      T2S     : 0        ,$
                                      FILE    : 's-c'    })
   



   ;-------> LEARNING
   LEARNW = LonArr(1)
   LEARNW(0) = Handle_Create(!MH, VALUE={INFO    :  'LEARN' ,$
                                         INDEX   :   0      ,$
                                         DW      :   0      ,$
;
                                         RULE    :  'LHLP2' ,$
                                         ALPHA   :   0.25   ,$
                                         GAMMA   :   0.001  ,$
                                         WIN     :  'ALPHA' ,$
                                         TAU_INC :   0.3866 ,$
                                         TAU_DEC :   4.     ,$
;
                                         RECCON  : 100      ,$ 
                                         SHOWW   : 500      ,$ 
                                         ZOOM    :   1      ,$ 
                                         TERM    :  10.     ,$ 
                                         NOMERCY :   0      })



   ;-------> INPUT
   MINPUT = LonArr(1)
   MINPUT(0) = Handle_Create(!MH, VALUE={INFO    : 'INPUT'  ,$
                                         INDEX   :    0     ,$
                                         LAYER   :    0     ,$
                                         SYNAPSE : 'FEEDING',$
                                         TYPE    : 'PCC'    ,$
                                         wrap    :  1       ,$
                                         v       :  0.8     ,$
                                         f       : [5.,40.],$
                                         sig     :  2.5     ,$
                                         p       :  1.0     ,$
                                         r       :  4       ,$
                                         xoff    :  0       ,$
                                         yoff    :  0       ,$
                                         dyn     :  1       ,$
                                         decay   :  1       ,$
                                         unique  :  1       })


   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   AP          = { DWW        : DWW           ,$ ; connection-informations
                   LW         : LW            ,$ ; layer-informations
                   LEARNW     : LEARNW        ,$ ; learning-informations
                   NWATCH     : NWATCH        ,$ ; neurons to be watched
                   INPUT      : MINPUT        ,$ ; input
                   SIMULATION : SIMULATION    ,$
;                   __TN       : "R/INPUT(0)"  ,$
;                   __TV       : [8,6,2]       ,$
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------  LOOPS ----------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
                   file       : ''            ,$
                   ofile      : ''            }


   Spawn, 'pwd', WorkDir
   WorkDir = WorkDir(0)
;   IF ExtraSet(e,'NOCP') THEN LocalDir = WorkDir ELSE LocalDir = GetLocalDir(WorkDir)
;   LocalDir = LocalDir+'/'+AP.SIMULATION.ver+'/'
   AP.OFile = RealFileName(WorkDir+'/'+AP.SIMULATION.ver+'/')
   AP.File = RealFileName(WorkDir+'/'+AP.SIMULATION.ver+'/')
   
   P     = AP
   _TIME = 0l
   

;;----------> DELETE OLD SIMS IF WANTED
   IF Keyword_Set(CLEAN) THEN BEGIN
      print, 'are you really shure to DELETE EVERYTHING in '+LocalDir+' ??'
      yn = Get_Kbrd(1)
      IF yn EQ 'y' THEN BEGIN
         print, 'ok'
         spawn, 'rm -f '+LocalDir+'*'
      END ELSE print, 'delete aborted'
   END
   
   
   IF NOT ExtraSet(e, 'NOGRAPHIC') AND NOT ExtraSet(e, 'PS') THEN BEGIN
      Window,0
      WDelete, 0
   END

   FakeEach
END
