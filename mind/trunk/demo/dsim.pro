;+
; NAME:                 DSIM
;
; PURPOSE:              A simple demo simulation. It implements two layer which are
;                       connected by a retinotopic Gaussian weight profile.
;
; CATEGORY:             MIND SIM DEMO
;
; CALLING SEQUENCE:     DSIM
;
; MODIFICATION HISTORY:
;
;     $Log$
;     Revision 1.3  2000/01/28 17:43:51  saam
;           just for transfer
;
;     Revision 1.2  2000/01/14 12:54:29  saam
;           uses the changed DWW system
;
;     Revision 1.1  2000/01/13 10:36:53  saam
;           hope it works
;
;
;-

PRO DSIM, _EXTRA=e ;,CLEAN
  
   COMMON SH_Q, Qwins, Q_1
   COMMON COMMON_Random, seed
   COMMON ATTENTION, AP, P, _TIME

;   RESOLVE_All
;   seed = 1234567

   Freeeachhandle
   UClose,/ALL

   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------

   ;-------> GLOBAL PARAMETERS
   SIMULATION = {VER    : '.'        ,$
                 TIME   :     50l    ,$
                 SAMPLE :      0.001 }


   ;-------> LOG OUTPUTS
   CON = { MODE     : 'win' } ; for all other parameters we just want the default


   ;-------> LAYERS
   LW = LonArr(2)
   LW(0) = Handle_Create(!MH, VALUE={INFO   : 'LAYER'           ,$
                                     w      :     21            ,$
                                     h      :     21            ,$
                                     name   : 'Simple Cells'    ,$
                                     file   : 's'               ,$
                                     NPW    : {  INFO : 'INITPARA_6' ,$
                                                 TAUF       : [0.2789d, 9.0d],$
                                                 TAUL       : [0.3866d, 4.0d],$
                                                 TAUI       :  10.0d         ,$
                                                 VS         :   2.0d         ,$
                                                 TAUS       :  10.0d         ,$
                                                 VR         :   0.0d         ,$
                                                 TAUR       :   5.0d         ,$
                                                 TH0        :   0.3d         ,$
                                                 FADE       : 200            ,$
                                                 SIGMA      :   0.0d         ,$
                                                 NOISYSTART : 0.0d           ,$
                                                 SPIKENOISE :   0.0d         },$
                                     LEX    : { INFO       : 'LAYEREXTRA',$
                                                REC_O      : [0l, SIMULATION.TIME],$
                                                REC_M      : [0l,0l]              ,$
                                                REC_MUA    : 1                    ,$
                                                ANALYZE    : 0                    ,$
                                                SPIKERASTER: 1                    }})

   LW(1) = Handle_Create(!MH, VALUE={INFO   : 'LAYER'           ,$
                                     w      :     21            ,$
                                     h      :     21            ,$
                                     name   : 'Complex Cells'   ,$
                                     file   : 'c'               ,$
                                     NPW    : {  INFO       : 'INITPARA_6'   ,$
                                                 TAUF       : [0.2789d, 9.0d],$
                                                 TAUL       : [0.3866d, 4.0d],$
                                                 TAUI       :  10.0d         ,$
                                                 VS         :   2.0d         ,$
                                                 TAUS       :  10.0d         ,$
                                                 VR         :   0.0d         ,$
                                                 TAUR       :   5.0d         ,$
                                                 TH0        :   0.3d         ,$
                                                 FADE       : 200            ,$
                                                 SIGMA      :   0.0d         ,$
                                                 NOISYSTART : 0.0d           ,$
                                                 SPIKENOISE :   0.0d         },$
                                     LEX    : { INFO       : 'LAYEREXTRA',$
                                                REC_O      : [0l, SIMULATION.TIME],$
                                                REC_M      : [0l,0l]              ,$
                                                REC_MUA    : 1                    ,$
                                                ANALYZE    : 0                    ,$
                                                SPIKERASTER: 1                    }})



   ;-------> WATCH NEURONS
   NWatch = LonArr(2)
   NWatch(0) = Handle_Create(!MH, VALUE={L :   0,$
                                         w :  11,$
                                         h :  11})
   NWatch(1) = Handle_Create(!MH, VALUE={L :   1,$
                                         w :  11,$
                                         h :  11})


   
   ;-------> CONNECTIONS
   DWW = LonArr(1)
   DWW(0) = Handle_Create(!MH, VALUE={INFO    : 'DWW'    ,$
                                      NAME    : 'S->C'   ,$
                                      SYNAPSE : 'FEEDING',$
                                      SOURCE  : 0        ,$
                                      TARGET  : 1        ,$
                                      BOUND   : 'TOROID' ,$
                                      SELF    : 'SELF'   ,$
                                      WINIT   : {INFO : 'DWWINIT' ,$
                                                 TYPE : 'GAUSSIAN',$
                                                 A    :  0.05     ,$
                                                 S    : 10.       ,$
                                                 R    : 11        ,$
                                                 N    :  0.025    ,$
                                                 NORM :  0        },$
                                      DINIT   : {INFO : 'DWDINIT' ,$
                                                 TYPE : 'LINEAR'  ,$
                                                 M    :  1        ,$
                                                 D    : 12        ,$
                                                 R    : 11        },$
                                      T2S     : 0        ,$
                                      FILE    : 's-c'    })
   



   ;-------> LEARNING
   LEARNW = LonArr(1)
   LEARNW(0) = Handle_Create(!MH, VALUE={INFO    :  'LEARN' ,$
                                         INDEX   :   0      ,$
                                         DW      :   0      ,$
;
                                         RULE    :  'LHLP2' ,$
                                         ALPHA   :   0.25   ,$
                                         GAMMA   :   0.001  ,$
                                         WIN     :  'ALPHA' ,$
                                         TAU_INC :   0.3866 ,$
                                         TAU_DEC :   4.     ,$
;
                                         RECCON  : 100      ,$ 
                                         SHOWW   : 500      ,$ 
                                         ZOOM    :   1      ,$ 
                                         TERM    :  10.     ,$ 
                                         NOMERCY :   0      })



   ;-------> INPUT
   MFILTER = LonArr(3)
   MFILTER(0) = Handle_Create(!MH, VALUE={ NAME   : 'sifpoissonc'   ,$
                                           start  :     10          ,$
                                           stop   :     90          $
                                         })
   MFILTER(1) = Handle_Create(!MH, VALUE={ NAME   : 'sifnjitter'    ,$
                                           start  :     10          ,$
                                           stop   :     90          ,$
                                           params : { jitter:2 }     $
                                         })
   MFILTER(2) = Handle_Create(!MH, VALUE={ NAME   : 'ifconst'       ,$
                                           start  :      0          ,$
                                           stop   :     50          ,$
                                           params : { value : 2. }   $
                                         })


   MINPUT = LonArr(2)
   MINPUT(0) = Handle_Create(!MH, VALUE={INFO     : 'INPUT'     ,$
                                         INDEX    :     0       ,$
                                         LAYER    :     0       ,$
                                         SYNAPSE  : 'FEEDING'   ,$
                                         TYPE     : 'EXTERN'    ,$
                                         PERIOD   :    -1       ,$
                                         TIME_STEP:    -1       ,$
                                         VISIBLE  :     1       ,$
                                         FILTERS  : MFILTER(0:1) $
                                         })
   MINPUT(1) = Handle_Create(!MH, VALUE={INFO     : 'INPUT'  ,$
                                         INDEX    :     1    ,$
                                         LAYER    :     0    ,$
                                         SYNAPSE  : 'DIRECT' ,$
                                         TYPE     : 'EXTERN' ,$
                                         PERIOD   :    -1    ,$
                                         TIME_STEP:    -1    ,$
                                         VISIBLE  :     1    ,$
                                         FILTERS  : MFILTER(2)$
                                         })

   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   AP          = { DWW        : DWW                    ,$ ; connection-informations
                   LW         : LW                     ,$ ; layer-informations
                   LEARNW     : LEARNW                 ,$ ; learning-informations
                   NWATCH     : NWATCH                 ,$ ; neurons to be watched
                   INPUT      : MINPUT                 ,$ ; input
                   SIMULATION : SIMULATION             ,$
                   CON        : InitConsole(_EXTRA=CON),$
;                   __TN       : "R/INPUT(0)"          ,$
;                   __TV       : [8,6,2]               ,$
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------  LOOPS ----------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
   ;---------------------------------------------------------------------------------------------------------------------------------------------------------
                   file       : ''            ,$
                   ofile      : ''            }


   Spawn, 'pwd', WorkDir
   WorkDir = WorkDir(0)
;   IF ExtraSet(e,'NOCP') THEN LocalDir = WorkDir ELSE LocalDir = GetLocalDir(WorkDir)
;   LocalDir = LocalDir+'/'+AP.SIMULATION.ver+'/'
   AP.OFile = RealFileName(WorkDir+'/'+AP.SIMULATION.ver+'/')
   AP.File = RealFileName(WorkDir+'/'+AP.SIMULATION.ver+'/')
   
   P     = AP
   _TIME = 0l
   

;;----------> DELETE OLD SIMS IF WANTED
   IF Keyword_Set(CLEAN) THEN BEGIN
      print, 'are you really shure to DELETE EVERYTHING in '+LocalDir+' ??'
      yn = Get_Kbrd(1)
      IF yn EQ 'y' THEN BEGIN
         print, 'ok'
         spawn, 'rm -f '+LocalDir+'*'
      END ELSE print, 'delete aborted'
   END
   
   
   IF NOT ExtraSet(e, 'NOGRAPHIC') AND NOT ExtraSet(e, 'PS') THEN BEGIN
      Window,0
      WDelete, 0
   END

   FakeEach
END
